<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Language" content="en">
  <meta name="color-scheme" content="light dark">

  <meta name="author" content="Kevin Bonham">
  <meta name="description" content="Kevin Bonham's website">
  <meta name="keywords" content="microbiome,data science,teaching,immune system">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="kbonham">
  <meta name="twitter:description" content="Kevin Bonham's website">

  <meta property="og:title" content="summary">
  <meta property="og:description" content="Kevin Bonham's website">
  <meta property="og:type" content="website">

  <title>kbonham</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css" integrity="sha256-XoaMnoYC5TH6/+ihMEnospgm0J1PM/nioxbOUdnM8HY=" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/coder.min.css" media="screen">
  <link rel="stylesheet" href="/css/coder-dark.min.css" media="screen">

  <link rel="icon" type="image/png" href="/assets/infra/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/assets/infra/favicon-16x16.png" sizes="16x16">

  <link rel="apple-touch-icon" href="/assets/infra/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/infra/apple-touch-icon.png">

  
  <meta name="generator" content="Franklin.jl" />

  

  
    <link rel="stylesheet" href="/libs/highlight/atom-one-dark.css">
  

  <style>
  :root {
    --block-background: #f4f0ec;
  }
  .hljs {
    padding: 1em;
  }
  </style>

</head>

<body class="preload-transitions colorscheme-auto">

  <div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
      <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
  </div>

  <main class="wrapper">

    <nav class="navigation">
  <section class="container">

    <a class="navigation-title" href="/">
      kbonham
    </a>

    <input type="checkbox" id="menu-toggle">
    <label class="menu-button float-right" for="menu-toggle">
      <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
    </label>

    <ul class="navigation-list">
      
        <li class="navigation-item">
          <a class="navigation-link" href="/about/">About</a>
        </li>
      
        <li class="navigation-item">
          <a class="navigation-link" href="/posts/">Blog</a>
        </li>
      
        <li class="navigation-item">
          <a class="navigation-link" href="https://github.com/kescobo/blog.bonham.ch/tree/main/webeasties">We, Beasties</a>
        </li>
      
        <li class="navigation-item">
          <a class="navigation-link" href="/contact/">Contact me</a>
        </li>
      

      
      
    </ul>

  </section>
</nav>


    <div class="content">

        
        <section class="container post">
          <header>
  <div class="post-title">
    <h1 class="title">
      <a class="title-link" href="/posts/webeasties-1/index.html">
        We, Beasties recovery - Part 1
      </a>
    </h1>
  </div>

  <div class="post-meta">
    
      <div class="date">
        <span class="posted-on">
          <i class="fa fa-calendar" aria-hidden="true"></i>
          <time datetime='2020-01-06'>
            January 6, 2020
          </time>
        </span>
        
        
      </div>
    

    
      <div class="tags">
        <i class="fa fa-tag" aria-hidden="true"></i>
        <span class="tag"><a href="/tags/julia/">julia</a></span><span class="separator">•</span><span class="tag"><a href="/tags/web/">web</a></span><span class="separator">•</span><span class="tag"><a href="/tags/microbiology/">microbiology</a></span>
      </div>
    
  </div>
</header>


       
       
       
<p>Every new year, I tell myself that this is the year I'm going to start blogging again.
Sometimes, I even <a href="/posts/2017/back-on-the-horse.md">write posts</a>
saying "this year will be different,"
and then that ends up being my only post of the year.</p>
<p>I used to love blogging - I had a relatively popular blog on <a href="https://scienceblogs.com/webeasties">ScienceBlogs.com</a>
called "We, Beasties" - a not-so-subtle homage to <a href="https://en.wikipedia.org/wiki/I,_Robot">Isaac Asimov</a>
and <a href="https://www.indiebound.org/book/9780156027779">Paul de Kruif</a> -
which ended in 2013 when I got recruited to start
an <a href="https://blogs.scientificamerican.com/food-matters/">ill-fated blog</a>
at Scientific American.</p>
<p>What I do now is very different than what I was doing in 2013,
but I'm always thinking I should get back into it.
What better way to do that than to use my new skills to collect my old content?</p>
<h2 id=""scraping"_old_posts" > "Scraping" old posts<a class="heading-link" href="#"scraping"_old_posts">
  <i class="fa fa-link" aria-hidden="true"></i>
</a>
</h2><p>Initially, I was expecting to have to do some complicated html parsing,
crawling through each post and finding back links,
but it turns out the old scienceblogs.com website is actually
pretty well laid out.</p>
<p>First, I went to <a href="https://scienceblogs.com/author/kbonham">my author page</a>,
which lists all of my posts in pagenated form.
In the browser, I right-clicked in the page, and selected "view source"
to see the underlying html (which is how the page will be downloaded).</p>
<p>A few things jump out right away:</p>
<ol>
<li>The blocks that contain links to previous posts look like</li>
</ol>
   <pre><code class="html">   &lt;h5 class=&quot;field-content&quot;&gt;&lt;a href=&quot;/webeasties/2013/09/03/we-beasties-sproulates&quot; hreflang=&quot;und&quot;&gt;We, Beasties Sporulates&lt;/a&gt;&lt;/h5&gt;
   </code></pre>
<ol start="2">
<li>The individual pages of posts all have the same url as the author page,
   ending in <code>?page=N</code>, where <code>N</code> is a number <code>0:7</code>.</li>
</ol>
<p>So really, all I need to do is download each of those pages,
search for all of the <code>webeasties</code> urls,
and then download all of <em>those</em> pages.</p>
<p>Pretty simple. The code in this post is all run
with julia Version 1.6.0-DEV.1722 (2020-12-09) (but should work on any julia v1).
project files <a href="content/juliaprojects/webscrape/">can be found here</a>.
In code blocks below, I have a mix of script-like and REPL commans,
the latter are just to easily show outputs.
I do most of my julia coding and running using the <a href="https://www.julia-vscode.org/">VS Code julia extension</a>.</p>
<h3 id="looping_through_author_pages" > Looping through author pages<a class="heading-link" href="#looping_through_author_pages">
  <i class="fa fa-link" aria-hidden="true"></i>
</a>
</h3><p>Since each author page has the same url save one number,
I just cycled through them in a loop of the numbers.
In each case, I downloaded the page into a temporary file,
scan it for <code>webeasties</code> urls, and store them in a set.</p>
<p>Note: you should really never use Regex to parse an HTML file,
but I'm not <em>really</em> parsing them, I actually am looking for a simple pattern.</p>
<pre><code class="julia">using Downloads: download

posturls = Set(String[])
baseurl = &quot;https://scienceblogs.com/author/kbonham?page=&quot;
projectdir = normpath(pwd(), &quot;_assets/literate/webeasties/&quot;)
isdir(projectdir) || mkpath(projectdir)

# for p in 0:7
let p = 0
    tmp = download(baseurl*string(p))
    # for line in eachline(tmp)
    for line in first(eachline(tmp), 5)
        for m in eachmatch(r&quot;href=\&quot;(/webeasties[\w/\-]+)\&quot;&quot;, line)
           push!(posturls, m[1])
        end
    end
end

posturls</code></pre>
<div class="code-output"><pre><code class="code-result language-plaintext">Set{String}()</code></pre></div><pre><code class="julia">length(posturls) # for the full set, this is 192</code></pre>
<div class="code-output"><pre><code class="code-result language-plaintext">0</code></pre></div><p>Explanation of regex:</p>
<ul>
<li><code>href=\&quot;/webeasties</code>: hoepfully self-explanatory, the <code>href</code> looks specifically
  for links, and the <code>&quot;</code> needs to be escaped.</li>
<li><code>[\w/\-]+</code>: match any number of word (<code>a-z</code>, <code>A-Z</code>, <code>0-9</code>, and <code>_</code>) characters,
  forward slashes or dashes</li>
<li><code>\&quot;</code> closing out the string.</li>
</ul>
<h3 id="downloading_html_pages" > Downloading html pages<a class="heading-link" href="#downloading_html_pages">
  <i class="fa fa-link" aria-hidden="true"></i>
</a>
</h3><p>The next bit is using the same idea,
except I suspected (correctly) that getting the parsing right would take me a few tries.
So rather than fetch each page dynamically and parse it,
I decided to save the html pages to a more permanent location.</p>
<p>In addition, I wanted to include the date and title in the file names,
but not separate by directory, so I did a bit of parsing of the parent url
to generate the new string with the date included.</p>
<p>Finally, I also put in a short <code>sleep()</code> to pause the loop so the site doesn't
think it's being DDOS'ed.
Not that ~200 requests is all that heavy a load, but it's an old site,
and I didn't really notice the difference,
since I could write what I did while I was waiting.</p>
<pre><code class="julia">htmlout = joinpath(projectdir, &quot;html_out&quot;)
isdir(htmlout) || mkdir(htmlout)

# this post wasn't available anymore, so I removed it
setdiff!(posturls, Set([&quot;/webeasties/2010/12/26/weekend-review-all-about-the-g&quot;]))
posturls

for url in posturls
    m = match(r&quot;^/webeasties/(\d&lbrace;4&rbrace;/\d&lbrace;2&rbrace;/\d&lbrace;2&rbrace;)/([\w/\-]+)$&quot;, url)
    isnothing(m) &amp;&amp; error(&quot;url $url doesn't match&quot;)
    dt, title = m.captures
    dt = replace(dt, '/'=&gt;&quot;&quot;) # remove /, so eg 2013/01/25 becomes 20130125
    file = &quot;$(dt)_$title.html&quot;

    # skips files that already exist since I ran into some errors, I didn't want to re-do them
    isfile(joinpath(htmlout, file)) || download(&quot;https://scienceblogs.com&quot; * url, joinpath(htmlout, file))
    sleep(0.1)
end</code></pre>
<h1 id="alright,_i_have_a_bunch_of_html_files,_what_now?" > Alright, I have a bunch of <code>html</code> files, what now?<a class="heading-link" href="#alright,_i_have_a_bunch_of_html_files,_what_now?">
  <i class="fa fa-link" aria-hidden="true"></i>
</a>
</h1><h2 id="parsing_posts" > Parsing posts<a class="heading-link" href="#parsing_posts">
  <i class="fa fa-link" aria-hidden="true"></i>
</a>
</h2><p>h/t: For this section, I got a bunch of inspiration <a href="https://hyphaebeast.club/writing/julia-web-scraping/#html-as-xml">from here</a>.</p>
<p>There's a bunch of <a href="https://jel.jewish-languages.org/words/503">schmutz</a> in these html documents
used for ads, SEO, and linking around the site,
none of which I want.
So my task in this section is to pull out just the main post content,
any other relavent info (like title etc),
and put them into a markdown file.</p>
<p>Here, I'm using the <a href="https://juliaio.github.io/EzXML.jl/stable/manual/#XPath-1"><code>EzXML.jl</code></a> package
and its <a href="https://www.w3schools.com/xml/xpath_intro.asp">XPath</a> query ability
to parse and search my <code>.html</code> files
(the HTML spec is just a flavor of XML).</p>
<h3 id="a_note_on_writing_loops" > A note on writing loops<a class="heading-link" href="#a_note_on_writing_loops">
  <i class="fa fa-link" aria-hidden="true"></i>
</a>
</h3><p>When I'm going to do something in a loop like this,
knowing it's going to take me a while to figure out exactly what to do,
I'll often pull some examples first.</p>
<p>For example, knowing I have an array of html file paths,
and that I'm going to loop through them with <code>for p in paths</code>,
the first thing I do is pull out just one example to work on.</p>
<pre><code class="julia">using EzXML

paths = readdir(htmlout, join=true)
p = first(paths) # for p in paths

post = readhtml(p)
doc = root(post)
# ...

# end</code></pre>
<div class="code-output"><pre><code class="code-stdout language-plaintext"><span class="sgr92"><span class="sgr1">Precompiling</span></span> EzXML...
    517.2 ms<span class="sgr32">  ✓ </span><span class="sgr90">XML2_jll</span>
    847.0 ms<span class="sgr32">  ✓ </span>EzXML
  2 dependencies successfully precompiled in 1 seconds. 8 already precompiled.
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag section invalid from HTML parser (code: 801, line: 44)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag header invalid from HTML parser (code: 801, line: 64)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag section invalid from HTML parser (code: 801, line: 71)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag nav invalid from HTML parser (code: 801, line: 116)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag section invalid from HTML parser (code: 801, line: 169)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag section invalid from HTML parser (code: 801, line: 201)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 251)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 254)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag section invalid from HTML parser (code: 801, line: 292)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag section invalid from HTML parser (code: 801, line: 315)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 320)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag mark invalid from HTML parser (code: 801, line: 321)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag footer invalid from HTML parser (code: 801, line: 337)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 341)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 360)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag mark invalid from HTML parser (code: 801, line: 361)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag footer invalid from HTML parser (code: 801, line: 375)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 379)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 398)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag mark invalid from HTML parser (code: 801, line: 399)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag footer invalid from HTML parser (code: 801, line: 413)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 417)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 436)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag mark invalid from HTML parser (code: 801, line: 437)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag footer invalid from HTML parser (code: 801, line: 451)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 455)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 474)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag mark invalid from HTML parser (code: 801, line: 475)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag footer invalid from HTML parser (code: 801, line: 489)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 493)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 512)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag mark invalid from HTML parser (code: 801, line: 513)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag footer invalid from HTML parser (code: 801, line: 528)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 532)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 551)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag mark invalid from HTML parser (code: 801, line: 552)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag footer invalid from HTML parser (code: 801, line: 569)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 573)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 591)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag mark invalid from HTML parser (code: 801, line: 592)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag footer invalid from HTML parser (code: 801, line: 607)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 611)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 629)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag mark invalid from HTML parser (code: 801, line: 630)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag footer invalid from HTML parser (code: 801, line: 644)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 648)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 666)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag mark invalid from HTML parser (code: 801, line: 667)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag footer invalid from HTML parser (code: 801, line: 682)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag article invalid from HTML parser (code: 801, line: 686)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag aside invalid from HTML parser (code: 801, line: 719)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag section invalid from HTML parser (code: 801, line: 724)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag section invalid from HTML parser (code: 801, line: 738)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag footer invalid from HTML parser (code: 801, line: 842)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag section invalid from HTML parser (code: 801, line: 848)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag footer invalid from HTML parser (code: 801, line: 898)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag section invalid from HTML parser (code: 801, line: 903)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>XMLError: Tag section invalid from HTML parser (code: 801, line: 917)
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ EzXML ~/.julia/packages/EzXML/DL8na/src/error.jl:97</span>
</code></pre><pre><code class="code-result language-plaintext">EzXML.Node(<ELEMENT_NODE[html]@0x000000002bd0b440>)</code></pre></div><p>This way, once I get it working on one instance,
I can just delete the first line, uncomment the <code>for</code> loop bits,
and then run it on the whole thing.
I put in validation checks that throw errors if something violates my assumptions
(like the fact there should only be one <code>content</code> and one <code>title</code> node)
so that the loop will break and tell me where to look to fix my assumptions.</p>
<h3 id="getting_stuff_with_xpath" > Getting stuff with XPath<a class="heading-link" href="#getting_stuff_with_xpath">
  <i class="fa fa-link" aria-hidden="true"></i>
</a>
</h3><p>My process here was not particularly fancy -
I went to the first post on the web,
copied the title and first couple of words of content,
then went to the html file and searched for them.
Happily, they appear in blocks that have unique selectors.
Actually, the title is in two places:</p>
<pre><code class="html">&lt;title&gt;Why every &amp;quot;OMG we&amp;#039;ve cured cancer!!&amp;quot; article is about melanoma | ScienceBlogs&lt;/title&gt;

&lt;h1 class=&quot;page-header&quot;&gt;&lt;span&gt;Why every &amp;quot;OMG we&amp;#039;ve cured cancer!!&amp;quot; article is about melanoma&lt;/span&gt;</code></pre>
<p>The <code>&lt;title&gt;</code> one is easier to grab, so I just went with that.
XPath lets you look for any node named "title", wherever it is.
Just to be sure there really is only one node,
I also made sure to check the length of the returned value.</p>
<pre><code class="julia">title = findall(&quot;//title&quot;, doc) # could have done `findfirst` instead, but then couldn't check if it's unique
length(title) != 1 &amp;&amp; error(&quot;Expected only 1 title block, got $(length(title)) from $p&quot;)
title = first(title) # get it out of the array

title.content</code></pre>
<div class="code-output"><pre><code class="code-result language-plaintext">"Ebola Outbreak in Uganda - Both More and Less Frightening Than You Think | ScienceBlogs"</code></pre></div><p>The post itself is wrapped in <code>&lt;div class=&quot;content&quot;&gt;</code>,
which we can also easily find with XPath:</p>
<pre><code class="julia">body = findall(&quot;//div[@class=\&quot;content\&quot;]&quot;, doc)
length(body) != 1 &amp;&amp; error(&quot;Expected only 1 content block, got $(length(body)) from $p&quot;)
body = first(body)

body.content</code></pre>
<div class="code-output"><pre><code class="code-result language-plaintext">"\n    \n            In case you missed it, over the past couple of days there have been reports of an outbreak of Ebola hemorrhagic  fever virus in Uganda. As of this writing, the most recent report I've seen puts the death toll at 16, with a few other suspected cases. Ebola is terrifying for a number of reasons - it's readily transmissible, it has a remarkably high and rapid lethality (25-90% case fatality rate within days to weeks), and the way it kills is gruesome - causing massive bleeding from all orifices. There's no vaccine or cure.\nThe good news from an epidemiology standpoint though, is that Ebola is a kinda terrible pathogen in humans. It has a short incubation time, and infected people are obvious (what with the bleeding from their eyes). Further, it's not airborne, so you actually have to come into contact with bodily fluids from infected individuals to become infected yourself. Once an outbreak has been identified, health workers can take fairly simple precautions and dramatically reduce their risk of infection. What this means in a practical sense is that, after the first terrifying days of lots of sick people turning up, people know what to do to avoid infection, and the outbreak burns itself out. Since its discovery in 1976, Ebola has killed less than 2000 people, with the worst outbreak in 2000 killing 224. Contrast that with your garden variety influenza, which kills on average 40,000 people per year in the US alone, and hundreds of thousands more around the globe.\nRemember, the goal of a pathogen is not to kill you. Your death is an unintended side-effect of the real goal: replication and transmission. On this front, Ebola sucks. It's great at evading your immune system and replicating like crazy, but then it makes you terrifying to other potential hosts and incapacitates or kills you before you have a chance to spread it very far. The most successful pathogens strike a balance between replication and transmission. Influenza generally leaves you healthy enough to walk around and shake hands, press the elevator button at work, and use an ATM. Influenza doesn't want you dead - the only reason it kills so many people is that so many more people become infected. Successful pathogens that make most of their victims really really sick or dead have more efficient ways to be transmitted that don't require you to be healthy and mobile. Malaria has mosquitoes do the work of getting the infection mobile, cholera gives folks massive diarrhea to spread itself in water sources, Bacillus anthracis (anthrax) can form spores that survive time, heat and desiccation for decades while waiting for a new host.\nSo, Ebola is not really as scary as it seems. The really scary thing about this outbreak and others is that it reminds us that brand new diseases come out of previously isolated areas, and that globalization and urbanization means that the distance between a rural village in Africa and every major city on the planet is small and shrinking. This most recent outbreak of Ebola had victims in Kampala - the capital of Uganda. It's fairly easy to imagine an international traveler hoping a plane from Kampala to Paris and then... Well, Ebola probably wouldn't get much further for the reasons I already mentioned, but some other virus?\nNew infectious diseases generally pass into humans from animals, but they're poorly adapted for our immune systems. Generally, this means that they either don't replicate very well, or are difficult to transmit, or they're super deadly and wipe out their hosts too quickly to be transmitted. The trouble with cities is that high population density lowers the bar on transmission, allowing more virulent bugs to make it to the big time. And rapid global transit means that any local outbreak has the potential to cause a global pandemic.\n\n      \n  \n    Tags\n          \n              Immune system\n          Microbes always win\n              \n      \nLog in to post comments\n  "</code></pre></div><p>One issue with using the content here is that, in html,
links are nested elements inside other elements.
In the <code>body.content</code>, those links are stripped out.
For example, up above, <code>I went to a seminar at TSRI that...</code> in the <code>content</code> string
is actually <code>I went to a seminar at &lt;a href=&quot;http://www.scripps.edu/e_index.html&quot;&gt;TSRI &lt;/a&gt;that...</code>
in the original html.</p>
<p>But, not to worry, those <code>&lt;a&gt;</code> links are just additional nodes
in the original <code>&lt;div class=&quot;content&quot;&gt;</code> node, so we can just find them with XPath.
The <code>body</code> node can still search the whole tree, so we use <code>.//</code>
to search inside this node</p>
<pre><code class="julia">links = findall(&quot;.//a[@href]&quot;, body)

length(links)</code></pre>
<div class="code-output"><pre><code class="code-result language-plaintext">9</code></pre></div><p>But there are only 10 links in the post.
It turns out there are some tags inside the <code>body</code> node that have their own links.
So instead, I grab the first nested <code>div</code>, and then search inside that.</p>
<pre><code class="julia">post = findfirst(&quot;./div&quot;, body)
links = findall(&quot;.//a[@href]&quot;, post)

length(links)</code></pre>
<div class="code-output"><pre><code class="code-result language-plaintext">6</code></pre></div><pre><code class="julia">post.content # this ends up being a little nicer too</code></pre>
<div class="code-output"><pre><code class="code-result language-plaintext">"In case you missed it, over the past couple of days there have been reports of an outbreak of Ebola hemorrhagic  fever virus in Uganda. As of this writing, the most recent report I've seen puts the death toll at 16, with a few other suspected cases. Ebola is terrifying for a number of reasons - it's readily transmissible, it has a remarkably high and rapid lethality (25-90% case fatality rate within days to weeks), and the way it kills is gruesome - causing massive bleeding from all orifices. There's no vaccine or cure.\nThe good news from an epidemiology standpoint though, is that Ebola is a kinda terrible pathogen in humans. It has a short incubation time, and infected people are obvious (what with the bleeding from their eyes). Further, it's not airborne, so you actually have to come into contact with bodily fluids from infected individuals to become infected yourself. Once an outbreak has been identified, health workers can take fairly simple precautions and dramatically reduce their risk of infection. What this means in a practical sense is that, after the first terrifying days of lots of sick people turning up, people know what to do to avoid infection, and the outbreak burns itself out. Since its discovery in 1976, Ebola has killed less than 2000 people, with the worst outbreak in 2000 killing 224. Contrast that with your garden variety influenza, which kills on average 40,000 people per year in the US alone, and hundreds of thousands more around the globe.\nRemember, the goal of a pathogen is not to kill you. Your death is an unintended side-effect of the real goal: replication and transmission. On this front, Ebola sucks. It's great at evading your immune system and replicating like crazy, but then it makes you terrifying to other potential hosts and incapacitates or kills you before you have a chance to spread it very far. The most successful pathogens strike a balance between replication and transmission. Influenza generally leaves you healthy enough to walk around and shake hands, press the elevator button at work, and use an ATM. Influenza doesn't want you dead - the only reason it kills so many people is that so many more people become infected. Successful pathogens that make most of their victims really really sick or dead have more efficient ways to be transmitted that don't require you to be healthy and mobile. Malaria has mosquitoes do the work of getting the infection mobile, cholera gives folks massive diarrhea to spread itself in water sources, Bacillus anthracis (anthrax) can form spores that survive time, heat and desiccation for decades while waiting for a new host.\nSo, Ebola is not really as scary as it seems. The really scary thing about this outbreak and others is that it reminds us that brand new diseases come out of previously isolated areas, and that globalization and urbanization means that the distance between a rural village in Africa and every major city on the planet is small and shrinking. This most recent outbreak of Ebola had victims in Kampala - the capital of Uganda. It's fairly easy to imagine an international traveler hoping a plane from Kampala to Paris and then... Well, Ebola probably wouldn't get much further for the reasons I already mentioned, but some other virus?\nNew infectious diseases generally pass into humans from animals, but they're poorly adapted for our immune systems. Generally, this means that they either don't replicate very well, or are difficult to transmit, or they're super deadly and wipe out their hosts too quickly to be transmitted. The trouble with cities is that high population density lowers the bar on transmission, allowing more virulent bugs to make it to the big time. And rapid global transit means that any local outbreak has the potential to cause a global pandemic.\n"</code></pre></div><p>What about those tags? They're inside the <code>body</code> node in a <code>&lt;div class=&quot;field--item&quot;&gt;</code> node.
To get the tag, and do a bit of validation in case the organization is different,
I decided to parse the link inside that <code>div</code> node.
That is, take something like</p>
<pre><code class="html">&lt;div class=&quot;field--item&quot;&gt;&lt;a href=&quot;/tag/other-uses-immune-system&quot; hreflang=&quot;en&quot;&gt;Other uses of the immune system&lt;/a&gt;&lt;/div&gt;</code></pre>
<p>And get the link <code>&quot;/tag/other-uses-immune-system&quot;</code>, so that I could make sure
it starts with <code>/tag/</code>.</p>
<pre><code class="julia">function gettags(body)
    tags = String[]
    tagnodes = findall(&quot;.//div[@class=\&quot;field--item\&quot;]&quot;, body)
    for tagnode in tagnodes
        a = findfirst(&quot;./a[@href]&quot;, tagnode)
        link = first(attributes(a)).content
        m = match(r&quot;^/tag/([\w\-]+)$&quot;, link)
        isnothing(m) &amp;&amp; error(&quot;Expected tag, got $link&quot;)
        push!(tags, m.captures[1])
    end
    return tags
end

gettags(body)</code></pre>
<div class="code-output"><pre><code class="code-result language-plaintext">2-element Vector{String}:
 "immune-system"
 "microbes-always-win"</code></pre></div><h2 id="conclusion" > Conclusion<a class="heading-link" href="#conclusion">
  <i class="fa fa-link" aria-hidden="true"></i>
</a>
</h2><p>So now we have all the pieces,
I'll save converting the posts to markdown for the <a href="/posts/2021/webeasties-2">next post</a>.</p>
 

      
      </section>
    </div>


    <footer class="footer">
      <section class="container">
        © 2024 Kevin Bonham · Powered by
  <a href="https://franklin.jl">Franklin.jl</a> &
  <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
      </section>
    </footer>

  </main>

  

  
    <script src="/libs/highlight/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>
  

<script src="/libs/coder.min.js"></script>

</body>
</html>
