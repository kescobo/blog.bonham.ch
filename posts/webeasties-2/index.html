<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Language" content="en">
  <meta name="color-scheme" content="light dark">

  <meta name="author" content="Kevin Bonham">
  <meta name="description" content="Kevin Bonham's website">
  <meta name="keywords" content="microbiome,data science,teaching">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="kbonham">
  <meta name="twitter:description" content="Kevin Bonham's website">

  <meta property="og:title" content="summary">
  <meta property="og:description" content="Kevin Bonham's website">
  <meta property="og:type" content="website">

  <title>kbonham</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css" integrity="sha256-XoaMnoYC5TH6/+ihMEnospgm0J1PM/nioxbOUdnM8HY=" crossorigin="anonymous">
  <link rel="stylesheet" href="/categorical-ambiguity/css/coder.min.css" media="screen">
  <link rel="stylesheet" href="/categorical-ambiguity/css/coder-dark.min.css" media="screen">

  <link rel="icon" type="image/png" href="/categorical-ambiguity/assets/infra/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/categorical-ambiguity/assets/infra/favicon-16x16.png" sizes="16x16">

  <link rel="apple-touch-icon" href="/categorical-ambiguity/assets/infra/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/categorical-ambiguity/assets/infra/apple-touch-icon.png">

  
  <meta name="generator" content="Franklin.jl" />

  

  
    <link rel="stylesheet" href="/categorical-ambiguity/libs/highlight/atom-one-dark.css">
  

  <style>
  :root {
    --block-background: #f4f0ec;
  }
  .hljs {
    padding: 1em;
  }
  </style>

</head>

<body class="preload-transitions colorscheme-auto">

  <div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
      <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
  </div>

  <main class="wrapper">

    <nav class="navigation">
  <section class="container">

    <a class="navigation-title" href="/categorical-ambiguity/">
      kbonham
    </a>

    <input type="checkbox" id="menu-toggle">
    <label class="menu-button float-right" for="menu-toggle">
      <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
    </label>

    <ul class="navigation-list">
      
        <li class="navigation-item">
          <a class="navigation-link" href="/categorical-ambiguity/about/">About</a>
        </li>
      
        <li class="navigation-item">
          <a class="navigation-link" href="/categorical-ambiguity/posts/">Blog</a>
        </li>
      
        <li class="navigation-item">
          <a class="navigation-link" href="/categorical-ambiguity/projects/">Projects</a>
        </li>
      
        <li class="navigation-item">
          <a class="navigation-link" href="/categorical-ambiguity/contact/">Contact me</a>
        </li>
      

      
      
    </ul>

  </section>
</nav>


    <div class="content">

        
        <section class="container post">
          <header>
  <div class="post-title">
    <h1 class="title">
      <a class="title-link" href="/categorical-ambiguity/posts/webeasties-2/index.html">
        We, Beasties recovery - Part 2
      </a>
    </h1>
  </div>

  <div class="post-meta">
    
      <div class="date">
        <span class="posted-on">
          <i class="fa fa-calendar" aria-hidden="true"></i>
          <time datetime='2021-11-06'>
            November 6, 2021
          </time>
        </span>

        
      </div>
    

    
      <div class="tags">
        <i class="fa fa-tag" aria-hidden="true"></i>
        <span class="tag"><a href="/categorical-ambiguity/tags/microbiology/">microbiology</a></span><span class="separator">•</span><span class="tag"><a href="/categorical-ambiguity/tags/web/">web</a></span><span class="separator">•</span><span class="tag"><a href="/categorical-ambiguity/tags/julia/">julia</a></span>
      </div>
    
    </div>
  </header>


       
       
       
<p>Hey, it only took me 2 years to <a href="/categorical-ambiguity/posts/webeasties-1">get back to this</a>!
Let's jump right in.</p>
<h2 id="previously..." > Previously...<a class="heading-link" href="#previously...">
  <i class="fa fa-link" aria-hidden="true"></i>
</a>
</h2><p>At the end of the last post,
I had downloaded all of the html files
from my <a href="https://scienceblogs.com/webeasties">old blog, <em>We, Beasties</em></a>,
and pulled out the titles, dates, content (including links), and tags.</p>
<p>Now, I'd like to parse those and (crudely)
turn them into markdown that can be built by <a href="http://franklinjl.org"><code>Franklin.jl</code></a>.</p>
<h2 id="converting_html_to_markdown" > Converting html to markdown<a class="heading-link" href="#converting_html_to_markdown">
  <i class="fa fa-link" aria-hidden="true"></i>
</a>
</h2><p>I already figured out how to get all of the elements out of the HTML,
now it's just a matter of making them into markdown.</p>
<p>Let's review</p>
<pre><code class="julia">using EzXML

function gettags(body)
    tags = String[]
    tagnodes = findall(&quot;.//div[@class=\&quot;field--item\&quot;]&quot;, body)
    for tagnode in tagnodes
        a = findfirst(&quot;./a[@href]&quot;, tagnode)
        link = first(attributes(a)).content
        m = match(r&quot;^/tag/([\w\-]+)$&quot;, link)
        isnothing(m) &amp;&amp; continue
        push!(tags, m.captures[1])
    end
    return tags
end

function getcontent(path)

    post = readhtml(path)
    doc = root(post)
    title = findall(&quot;//title&quot;, doc) # could have done `findfirst` instead, but then couldn't check if it's unique
    length(title) != 1 &amp;&amp; error(&quot;Expected only 1 title block, got $(length(title)) from $p&quot;)
    title = first(title) |&gt; nodecontent # get it out of the array

    body = findall(&quot;//div[@class=\&quot;content\&quot;]&quot;, doc)
    length(body) != 1 &amp;&amp; error(&quot;Expected only 1 content block, got $(length(body)) from $path&quot;)
    body = first(body)
    
    tags = gettags(body)
    content = body.content
    links = findall(&quot;.//a[@href]&quot;, body)
    imgs = findall(&quot;.//img&quot;, body)

    return (; path, content, title, post, links, tags, imgs)
end</code></pre>
<pre><code class="julia">paths = readdir(htmlout, join=true)

stuff = getcontent(last(paths))
print(first(stuff.content, 1000), &quot;...&quot;)</code></pre>
<pre><code class="julia">first(stuff.links, 4)</code></pre>
<pre><code class="julia">stuff.tags</code></pre>
<p>This the <a href="https://scienceblogs.com/webeasties/2013/09/03/we-beasties-sproulates">last post</a>
I made on the blog in 2013.
It's got some pictures and a bunch of links, but not much other formatting,
so should be pretty straightforward.</p>
<p>The first thing I decided to tackle was how to deal with the links...</p>
<h3 id="link_nodes" > Link nodes<a class="heading-link" href="#link_nodes">
  <i class="fa fa-link" aria-hidden="true"></i>
</a>
</h3><p>Looking inside the contents of each element of <code>links</code>,
it looks like all of the useful info I need is there:</p>
<pre><code class="julia">link = stuff.links[2]
nodecontent(link)</code></pre>
<pre><code class="julia">nodecontent(first(attributes(link)))</code></pre>
<p>So all I need to do to start building the markdown is to find the text
inside <code>stuff.content</code>, and replace it with a markdown link.
Eg, <code>Paul de Kruif's</code> will become <code>[Paul de Kruif's](http://www.amazon...)</code>.</p>
<p>This is easily done with julia's <code>replace()</code> function.</p>
<pre><code class="julia">function make_md_links(content, links)
    for lnk in links
        repstring = nodecontent(lnk)
        link = nodecontent(first(attributes(lnk)))
        isempty(repstring) &amp;&amp; continue # first link doesn't have anything in it
        any(ext -&gt; endswith(link, ext), [&quot;.png&quot;, &quot;.jpeg&quot;, &quot;.jpg&quot;]) &amp;&amp; continue # skip images
        content = replace(content, repstring=&gt; 
                                   string(&quot;[&quot;, repstring, &quot;](&quot;, link, &quot;)&quot;),
                                   count=1)
    end
    return content
end

linkified = make_md_links(stuff.content, stuff.links)
print(first(linkified, 500), &quot;...&quot;)</code></pre>
<p>Easy!</p>
<p>Much harder is dealing with images.
When I was blogging back then, I didn't understand the importance
(for accessibility) of including link text,
so most image links are going to have empty content.</p>
<p>But I don't really need to reproduce these posts exactly,
so I settled on just downloading the images (if they exist)
and putting them all at the end.</p>
<pre><code class="julia">function append_image_links(content, links, imgs)
    ## don't proceed if there are no image links
    if isempty(imgs) &amp;&amp; !any(lnk-&gt; any(ext -&gt; endswith(nodecontent(first(attributes(lnk))), ext), [&quot;.png&quot;, &quot;.jpeg&quot;, &quot;.jpg&quot;]), links)
        return content
    end

    content *= string(&quot;\n\n ## Post Images\n\n&quot;)
    for lnk in links
        alttext = nodecontent(lnk)
        link = nodecontent(first(attributes(lnk)))
        isempty(alttext) &amp;&amp; (alttext = string(&quot;Image at $link&quot;))
        if any(ext -&gt; endswith(link, ext), [&quot;.png&quot;, &quot;.jpeg&quot;, &quot;.jpg&quot;])

            targetpath = joinpath(&quot;_assets&quot;, &quot;img&quot;, &quot;webeasties&quot;, basename(link))
            if !isfile(targetpath) # skip if already downloaded
                try
                    download(link, targetpath)
                catch
                    @error &quot;Couldn't download $link, skipping&quot;
                end
            end
            if !isfile(targetpath)
                content *= string(&quot;- &quot;, &quot;![&quot;, alttext, &quot;](/&quot;, targetpath, &quot;)\n&quot;)
            else
                content *= string(&quot;- Missing image: &quot;, alttext, &quot; | &quot;, link, &quot;\n&quot;)
            end
        end
    end

    for img in imgs
        link = findall(&quot;.//@src&quot;, img) |&gt; first |&gt; nodecontent
        alttext = findall(&quot;.//@alt&quot;, img)
        alttext = isempty(alttext) ? &quot;image at $link&quot; : alttext |&gt; first |&gt; nodecontent
        if startswith(link, &quot;/files/&quot;)
            targetpath = joinpath(&quot;_assets&quot;, &quot;img&quot;, &quot;webeasties&quot;, basename(link))

            if !isfile(targetpath) # skip if already downloaded
                download(string(&quot;https://scienceblogs.com&quot;, link), targetpath)
            end
            content *= string(&quot;- &quot;, &quot;![&quot;, alttext, &quot;](/&quot;, targetpath[2:end], &quot;)\n&quot;)
        end
    
    end
    return content
end</code></pre>
<pre><code class="julia">with_images = append_image_links(linkified, stuff.links, stuff.imgs)

print(last(with_images, 300))</code></pre>
<h2 id="saving_the_markdown" > Saving the markdown<a class="heading-link" href="#saving_the_markdown">
  <i class="fa fa-link" aria-hidden="true"></i>
</a>
</h2><p>Now I've got the content, it's time to save it.
For the purposed of this post,
I'll stick it in a temporary directory,
but eventually, I want it to go into <code>webeasties/</code>
in the repository for this website
so that I can build them with Franklin.</p>
<pre><code class="julia">mdoutput = mktempdir()

mdoutput = &quot;webeasties&quot;
isdir(mdoutput) || mkdir(mdoutput)

for p in paths
    @info p
    post = getcontent(p)
    post_text = replace(post.content, r&quot;(\S)\n(\S)&quot;=&gt; s&quot;\1\n\n\2&quot;) # replace stand-alone new lines with doubles
    post_text = replace(post_text, r&quot;\n+\s&lbrace;4&rbrace;Tags\n.+$&quot;s=&gt;&quot;&quot;) # replace garbage at the end of each post
    post_text = replace(post_text, '$'=&gt; raw&quot;\$&quot;) # franklin doesn't like these
    post_text = replace(post_text, r&quot;^\s&lbrace;4,&rbrace;&quot;=&gt; &quot;&quot;) # remove leading spaces
    post_text = replace(post_text, r&quot;\n&lbrace;3,&rbrace;&quot;s=&gt; &quot;\n\n&quot;) # remove anything more than 3 newlines
    post_text = make_md_links(post_text, post.links)
    post_text = append_image_links(post_text, post.links, post.imgs)


    (y, m, d, postfile) = match(r&quot;^(\d&lbrace;4&rbrace;)(\d&lbrace;2&rbrace;)(\d&lbrace;2&rbrace;)_(.+)&quot;, basename(post.path)).captures

    t = replace(post.title, r&quot; \| ScienceBlogs$&quot;=&gt;&quot;&quot;)
    t = replace(t, '&quot;'=&gt; &quot;'&quot;)
    outdir = joinpath(mdoutput, y)
    isdir(outdir) || mkdir(outdir)

    open(joinpath(mdoutput, y, replace(postfile, r&quot;html?$&quot;=&gt;&quot;md&quot;)), &quot;w&quot;) do io
        print(io, &quot;&quot;&quot;
        +++
        title = &quot;$t&quot;
        date = Date(&quot;$y-$m-$d&quot;)
        tags = $(post.tags)
        category = &quot;webeasties&quot;
        +++

        _This post initially appeared on [Science Blogs](http://scienceblogs.com/webeasties)_

        $post_text
        &quot;&quot;&quot;)
    end
end</code></pre>
<p>And that's it!
You can now see the <a href="/categorical-ambiguity/webeasties">archive here</a></p>


      </section>
    </div>

    <footer class="footer">
      <section class="container">
        © 2022 Kevin Bonham · Powered by
  <a href="https://franklin.jl">Franklin.jl</a> &
  <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
      </section>
    </footer>

  </main>

  

  
    <script src="/categorical-ambiguity/libs/highlight/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>
  

<script src="/categorical-ambiguity/libs/coder.min.js"></script>

</body>
</html>
